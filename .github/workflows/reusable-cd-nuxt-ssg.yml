name: Reusable CD Nuxt SSG

on:
  workflow_call:
    inputs:
      service-name:
        description: Docker Compose service name on target host
        required: true
        type: string
      image-name:
        description: Full GHCR image name without tag
        required: true
        type: string
      health-url:
        description: Health endpoint URL on target host
        required: true
        type: string
      port:
        description: Exposed service port
        required: false
        default: 80
        type: number
      environment:
        description: GitHub Environment name (staging or production)
        required: true
        type: string
      workdir:
        description: Project working directory
        required: false
        default: .
        type: string
      dockerfile:
        description: Dockerfile path relative to consumer repo root
        required: false
        default: Dockerfile
        type: string
      remote-path:
        description: Deploy path on target host containing compose file
        required: true
        type: string
      ssh-user:
        description: SSH user for deploy host
        required: true
        type: string
      ssh-port:
        description: SSH port
        required: false
        default: 22
        type: number
      compose-file:
        description: Compose file path relative to consumer repo root
        required: false
        default: docker-compose.yml
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}
    outputs:
      image-ref: ${{ steps.image.outputs.image_ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.workdir }}
          file: ${{ inputs.dockerfile }}
          push: true
          tags: |
            ${{ inputs.image-name }}:${{ github.sha }}

      - name: Prepare immutable image reference
        id: image
        run: |
          digest="${{ steps.build.outputs.digest }}"
          image_ref="${{ inputs.image-name }}@${digest}"
          echo "image_ref=${image_ref}" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Configure SSH
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${{ inputs.ssh-port }}" "${{ vars.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload compose file
        run: |
          ssh -p "${{ inputs.ssh-port }}" "${{ inputs.ssh-user }}@${{ vars.SSH_HOST }}" \
            "mkdir -p '${{ inputs.remote-path }}'"
          scp -P "${{ inputs.ssh-port }}" \
            "${{ inputs.compose-file }}" \
            "${{ inputs.ssh-user }}@${{ vars.SSH_HOST }}:${{ inputs.remote-path }}/${{ inputs.compose-file }}"

      - name: Deploy image digest over SSH
        run: |
          ssh -p "${{ inputs.ssh-port }}" "${{ inputs.ssh-user }}@${{ vars.SSH_HOST }}" <<EOF
          set -euo pipefail
          cd "${{ inputs.remote-path }}"
          cat > .deploy-override.yml <<OVERRIDE
          services:
            ${{ inputs.service-name }}:
              image: ${{ needs.build-and-push.outputs.image-ref }}
          OVERRIDE
          docker compose -f "${{ inputs.compose-file }}" -f .deploy-override.yml pull "${{ inputs.service-name }}"
          docker compose -f "${{ inputs.compose-file }}" -f .deploy-override.yml up -d --no-deps "${{ inputs.service-name }}"
          rm -f .deploy-override.yml
          EOF

      - name: Health check
        run: |
          timeout=180
          interval=5
          deadline=$(( $(date +%s) + timeout ))
          while [[ $(date +%s) -lt $deadline ]]; do
            if curl -fsS "${{ inputs.health-url }}" >/dev/null 2>&1; then
              exit 0
            fi
            sleep "$interval"
          done
          echo "Health check failed for ${{ inputs.health-url }}" >&2
          exit 1
